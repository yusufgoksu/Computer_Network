import socket

class WebClient_advance:
    def __init__(self, host, port=80):
        self.host = host
        self.port = port

    def web_client_advance(self, path="/"):
        client_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

        try:
            client_socket.connect((self.host, self.port))
            print(f"âœ… BaÄŸlantÄ± baÅŸarÄ±lÄ±: {self.host}:{self.port}")

            http_request = f"GET {path} HTTP/1.1\r\nHost: {self.host}\r\nConnection: close\r\n\r\n"
            client_socket.sendall(http_request.encode())

            response = b""  # YanÄ±tÄ± depolamak iÃ§in byte tÃ¼rÃ¼nde bir deÄŸiÅŸken
            while True:
                data = client_socket.recv(4096)  # 4 KB'lÄ±k bloklar halinde veri al
                if not data:
                    break
                response += data

            # YanÄ±tÄ± decode et
            response_str = response.decode(errors="ignore")
            print(response_str)  # Sunucudan gelen yanÄ±tÄ± yazdÄ±r

            # EÄŸer yanÄ±t bir yÃ¶nlendirme ise, yeni URL'ye istek gÃ¶nder
            if "HTTP/1.1 302" in response_str:
                location = self._extract_location(response_str)
                if location:
                    print(f"YÃ¶nlendirme bulundu, yeni URL: {location}")
                    return self.web_client_advance(location.lstrip('/'))  # YÃ¶nlendirilen sayfayÄ± takip et

            return response_str

        except Exception as e:
            print(f"âŒ Hata oluÅŸtu: {e}")
            return None

        finally:
            client_socket.close()
            print("BaÄŸlantÄ± kapatÄ±ldÄ±.")

    def _extract_location(self, response):
        """HTTP yanÄ±tÄ±ndan Location baÅŸlÄ±ÄŸÄ±nÄ± Ã§Ä±karÄ±r."""
        lines = response.split("\r\n")
        for line in lines:
            if line.lower().startswith("location:"):
                return line.split(":", 1)[1].strip()
        return None


if __name__ == "__main__":
    # Yerel Sunucuya BaÄŸlan ve HTTP Ä°steÄŸi GÃ¶nder
    client = WebClient_advance("127.0.0.1", 80)  # Yerel Apache Sunucusuna BaÄŸlan
    response = client.web_client_advance("/")  # Ana sayfa iÃ§in "/" kullanÄ±yoruz

    if response:
        print("\n--- ğŸ“¥ Sunucudan Gelen Cevap ---\n")
        print(response)
