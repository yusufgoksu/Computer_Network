import socket

class WebClient_advance:
    def __init__(self, host, port=80):
        self.host = host
        self.port = port

    def web_client_advance(self, path="/"):
        client_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

        try:
            client_socket.connect((self.host, self.port))
            print(f"✅ Bağlantı başarılı: {self.host}:{self.port}")

            http_request = f"GET {path} HTTP/1.1\r\nHost: {self.host}\r\nConnection: close\r\n\r\n"
            client_socket.sendall(http_request.encode())

            response = b""  # Yanıtı depolamak için byte türünde bir değişken
            while True:
                data = client_socket.recv(4096)  # 4 KB'lık bloklar halinde veri al
                if not data:
                    break
                response += data

            # Yanıtı decode et
            response_str = response.decode(errors="ignore")
            print(response_str)  # Sunucudan gelen yanıtı yazdır

            # Eğer yanıt bir yönlendirme ise, yeni URL'ye istek gönder
            if "HTTP/1.1 302" in response_str:
                location = self._extract_location(response_str)
                if location:
                    print(f"Yönlendirme bulundu, yeni URL: {location}")
                    return self.web_client_advance(location.lstrip('/'))  # Yönlendirilen sayfayı takip et

            return response_str

        except Exception as e:
            print(f"❌ Hata oluştu: {e}")
            return None

        finally:
            client_socket.close()
            print("Bağlantı kapatıldı.")

    def _extract_location(self, response):
        """HTTP yanıtından Location başlığını çıkarır."""
        lines = response.split("\r\n")
        for line in lines:
            if line.lower().startswith("location:"):
                return line.split(":", 1)[1].strip()
        return None


if __name__ == "__main__":
    # Yerel Sunucuya Bağlan ve HTTP İsteği Gönder
    client = WebClient_advance("127.0.0.1", 80)  # Yerel Apache Sunucusuna Bağlan
    response = client.web_client_advance("/")  # Ana sayfa için "/" kullanıyoruz

    if response:
        print("\n--- 📥 Sunucudan Gelen Cevap ---\n")
        print(response)
